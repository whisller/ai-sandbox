#!/bin/bash
# Mimics docker sandbox behavior:
# - One container per workspace
# - Reuses existing container if running
# - State persists across sessions

# Check if WORKSPACE_PATH is set
if [ -z "$WORKSPACE_PATH" ]; then
    echo "Error: WORKSPACE_PATH environment variable is not set"
    echo "Set it in your shell config or .env file:"
    echo "  export WORKSPACE_PATH=/your/workspace/path"
    exit 1
fi

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

CONTAINER_NAME="claude-dev"

# Check if container exists and is running
if docker ps -q -f name="^${CONTAINER_NAME}$" | grep -q .; then
    echo "Connecting to existing claude container..."
    docker exec -it "${CONTAINER_NAME}" claude --dangerously-skip-permissions
elif docker ps -aq -f name="^${CONTAINER_NAME}$" | grep -q .; then
    echo "Starting stopped claude container..."
    docker start "${CONTAINER_NAME}"
    docker exec -it "${CONTAINER_NAME}" claude --dangerously-skip-permissions
else
    echo "Creating new claude container..."
    docker-compose -f docker-compose.yml -f docker-compose.ssh.yml up -d --build
    docker exec -it "${CONTAINER_NAME}" claude --dangerously-skip-permissions
fi
