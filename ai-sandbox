#!/bin/bash
# Mimics docker sandbox behavior:
# - One container per workspace
# - Reuses existing container if running
# - State persists across sessions
#
# Usage:
#   ./ai-sandbox                    # run with claude image (default)
#   ./ai-sandbox --build            # build then run claude image
#   ./ai-sandbox python             # run with python image
#   ./ai-sandbox python --build     # build then run python image

VARIANT="claude"
BUILD=false

for arg in "$@"; do
    case "$arg" in
        --build) BUILD=true ;;
        claude|python) VARIANT="$arg" ;;
        *) echo "Error: unknown argument '$arg'"; exit 1 ;;
    esac
done

# Check if AI_SANDBOX_WORKSPACE_PATH is set
if [ -z "$AI_SANDBOX_WORKSPACE_PATH" ]; then
    echo "Error: AI_SANDBOX_WORKSPACE_PATH environment variable is not set"
    echo "Set it in your shell config or .env file:"
    echo "  export AI_SANDBOX_WORKSPACE_PATH=/your/workspace/path"
    exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

CONTAINER_NAME="ai-sandbox"

if [ "$VARIANT" = "python" ]; then
    COMPOSE_FILES="-f docker-compose.yml -f docker-compose.python.yml -f docker-compose.ssh.yml"
else
    COMPOSE_FILES="-f docker-compose.yml -f docker-compose.ssh.yml"
fi

if [ "$BUILD" = true ]; then
    if [ "$VARIANT" = "python" ]; then
        echo "Building ai-sandbox:claude..."
        docker-compose -f docker-compose.yml build
        echo "Building ai-sandbox:python..."
        docker-compose -f docker-compose.yml -f docker-compose.python.yml build
    else
        echo "Building ai-sandbox:claude..."
        docker-compose -f docker-compose.yml build
    fi
fi

# Check if container exists and is running
if docker ps -q -f name="^${CONTAINER_NAME}$" | grep -q .; then
    echo "Connecting to existing container..."
    docker exec -it "${CONTAINER_NAME}" claude --dangerously-skip-permissions
elif docker ps -aq -f name="^${CONTAINER_NAME}$" | grep -q .; then
    echo "Starting stopped container..."
    docker start "${CONTAINER_NAME}"
    docker exec -it "${CONTAINER_NAME}" claude --dangerously-skip-permissions
else
    echo "Creating new container ($VARIANT)..."
    docker-compose $COMPOSE_FILES up -d
    docker exec -it "${CONTAINER_NAME}" claude --dangerously-skip-permissions
fi
