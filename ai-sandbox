#!/bin/bash
# Mimics docker sandbox behavior:
# - One container per workspace
# - Reuses existing container if running
# - State persists across sessions
#
# Usage:
#   ./ai-sandbox                              # run with claude image (default)
#   ./ai-sandbox --build                      # build then run claude image
#   ./ai-sandbox --with-spec-kit --build      # build with spec-kit commands baked in
#   ./ai-sandbox python                       # run with python image
#   ./ai-sandbox python --build               # build then run python image

VARIANT="claude"
BUILD=false
WITH_SPEC_KIT=false

for arg in "$@"; do
    case "$arg" in
        --build) BUILD=true ;;
        --with-spec-kit) WITH_SPEC_KIT=true ;;
        claude|python) VARIANT="$arg" ;;
        *) echo "Error: unknown argument '$arg'"; exit 1 ;;
    esac
done

# Check if AI_SANDBOX_WORKSPACE_PATH is set
if [ -z "$AI_SANDBOX_WORKSPACE_PATH" ]; then
    echo "Error: AI_SANDBOX_WORKSPACE_PATH environment variable is not set"
    echo "Set it in your shell config or .env file:"
    echo "  export AI_SANDBOX_WORKSPACE_PATH=/your/workspace/path"
    exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

CONTAINER_NAME="ai-sandbox"

if [ "$VARIANT" = "python" ]; then
    COMPOSE_FILES="-f docker-compose.yml -f docker-compose.python.yml -f docker-compose.ssh.yml"
else
    COMPOSE_FILES="-f docker-compose.yml -f docker-compose.ssh.yml"
fi

# Auto-detect cmux: include overlay when socket exists on host.
# Falls back to /tmp/cmux.sock (cmux default) if CMUX_SOCKET_PATH is not set.
# Guards against Docker Compose erroring on a missing bind-mount source.
CMUX_SOCKET_PATH="${CMUX_SOCKET_PATH:-/tmp/cmux.sock}"
if [ -S "${CMUX_SOCKET_PATH}" ]; then
    export CMUX_SOCKET_PATH
    COMPOSE_FILES="$COMPOSE_FILES -f docker-compose.cmux.yml"
    echo "cmux detected â€” notifications enabled (socket: $CMUX_SOCKET_PATH)"
fi

export WITH_SPEC_KIT

if [ "$BUILD" = true ]; then
    if [ "$VARIANT" = "python" ]; then
        echo "Building ai-sandbox:claude..."
        docker-compose -f docker-compose.yml build
        echo "Building ai-sandbox:python..."
        docker-compose -f docker-compose.yml -f docker-compose.python.yml build
    else
        echo "Building ai-sandbox:claude..."
        docker-compose -f docker-compose.yml build
    fi

    if docker ps -aq -f name="^${CONTAINER_NAME}$" | grep -q .; then
        echo "Recreating container with new image..."
        docker rm -f "${CONTAINER_NAME}"
    fi
fi

# Check if container exists and is running
if docker ps -q -f name="^${CONTAINER_NAME}$" | grep -q .; then
    echo "Connecting to existing container..."
    docker exec -it "${CONTAINER_NAME}" claude --dangerously-skip-permissions
elif docker ps -aq -f name="^${CONTAINER_NAME}$" | grep -q .; then
    echo "Starting stopped container..."
    docker start "${CONTAINER_NAME}"
    docker exec -it "${CONTAINER_NAME}" claude --dangerously-skip-permissions
else
    echo "Creating new container ($VARIANT)..."
    docker-compose $COMPOSE_FILES up -d
    docker exec -it "${CONTAINER_NAME}" claude --dangerously-skip-permissions
fi
